import{u as x,j as h,f as T,b as f,d as p,o as u,a as r,F as v,k as c,v as g,l as S,m as w,n as F,t as k,p as _,e as P,c as V,h as U}from"./app-DtnPqOnW.js";import{_ as A}from"./_plugin-vue_export-helper-DlAUqK2U.js";async function d(t,e="GET",i=null,a=null){var o,y;if(!navigator.onLine)return x().show("Вы не в сети!"),Promise.reject("Вы не в сети!");const s=((o=window.Telegram)==null?void 0:o.WebApp.initData)||null;h.defaults.headers.common["X-TG-DATA"]=s?btoa(s):null;const n=x();try{let l,b=!1;switch(e.toUpperCase()){case"POST":l=await h.post(t,i,a||void 0);break;case"PUT":b=!0,l=await h.put(t,i);break;case"DELETE":b=!0,l=await h.delete(t);break;case"GET":default:l=await h.get(t,a||void 0);break}return b&&n.show("Операция выполнена успешно","success"),l}catch(l){return((y=l==null?void 0:l.response)==null?void 0:y.status)===419?(n.show("Сессия истекла, страница будет перезагружена","warning"),window.location.reload(),Promise.reject("Сессия истекла")):(n.show(`Ошибка: ${(l==null?void 0:l.message)||"Неизвестная ошибка"}`),Promise.reject(l))}}const m="/bot-api/users",E=T("users",{state:()=>({items:[],self:null,loading:!1,progress:0,error:null}),getters:{byId:t=>e=>t.items.find(i=>i.id===e)},actions:{setRole(t){this.self.role=t},async fetchSelf(){this.loading=!0,this.error=null;try{const{data:t}=await d(`${m}/self`,"POST");this.self=t}catch(t){this.error=(t==null?void 0:t.message)||"Failed to load agents"}finally{this.loading=!1}return!0},async fetchFiltered(t=1){var e,i;this.loading=!0,this.error=null;try{const a=new URLSearchParams;Object.entries(this.filters).forEach(([n,o])=>{o!=null&&o!==""&&o!==!1&&a.append(n,String(o))}),a.append("sort_field",this.sort.field),a.append("sort_direction",this.sort.direction),a.append("page",String(t));const{data:s}=await d(`${m}?${a.toString()}`,"GET");this.items=s.data,this.pagination=s}catch(a){this.error=((i=(e=a.response)==null?void 0:e.data)==null?void 0:i.message)??"Ошибка загрузки пользователей"}finally{this.loading=!1}},setFilters(t){this.filters=t},setSort(t,e){this.sort={field:t,direction:e}},async fetchAll(){this.loading=!0,this.error=null;try{const{data:t}=await d(`${m}`,"GET");this.items=t.data,console.log("data=>",t)}catch(t){this.error=(t==null?void 0:t.message)||"Failed to load users"}finally{this.loading=!1}},async fetchAllByPage(t=1){const{data:e}=await d(`${m}?page=${t}`,"GET");this.items=e.data,this.pagination=e},async fetchByUrl(t){const{data:e}=await d(t,"GET");this.items=e.data,this.pagination=e},async fetchOne(t){try{const{data:e}=await d(`${m}/${t}`,"GET");return e}catch(e){throw this.error=(e==null?void 0:e.message)||"Failed to load user",e}},async uploadFormWithVideo(t,e){var a,s;this.loading=!0,this.error=null;const i=x();i.show("Загрузка файла началась");try{const n=new FormData;Object.entries(t).forEach(([l,b])=>{n.append(l,b)}),n.append("file",e),h.defaults.adapter="xhr";const{data:o}=await h.post(`${m}/send-video`,n,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:l=>{l.total&&(this.progress=Math.round(l.loaded*100/l.total))}});let y=o.message||"Файл успешно загружен";i.show(y,"success")}catch(n){const o=n;this.error=((s=(a=o.response)==null?void 0:a.data)==null?void 0:s.message)||"Ошибка при загрузке файла",i.show(this.error,"error")}finally{this.loading=!1}},async createPrimary(t){const{data:e}=await d(`${m}/primary`,"POST",t);return this.items.push(e),e},async create(t){const{data:e}=await d(`${m}`,"POST",t);return this.items.push(e),e},async update(t,e){const{data:i}=await d(`${m}/${t}`,"PUT",e),a=this.items.findIndex(s=>s.id===t);return a!==-1&&(this.items[a]=i),i},async remove(t){await d(`${m}/${t}`,"DELETE"),this.items=this.items.filter(e=>e.id!==t)},async getTelegramLink(t){await d(`${m}/${t}/tg`,"GET")},async updateRole(t,e){const{data:i}=await d(`${m}/${t}/role`,"POST",{role:e}),a=this.items.findIndex(s=>s.id===t);return a!==-1&&(this.items[a]=i),i},async updatePercent(t,e){const{data:i}=await d(`${m}/${t}/percent`,"PATCH",{percent:e}),a=this.items.findIndex(s=>s.id===t);return a!==-1&&(this.items[a]=i),i},async updateWorkStatus(t,e){const i=x(),{data:a}=await d(`${m}/${t}/work-status`,"POST",{is_work:e});i.show("Статус успешно обновлен");const s=this.items.findIndex(n=>n.id===t);return s!==-1&&(this.items[s]=a),a},async block(t,e){const{data:i}=await d(`${m}/${t}/block`,"PATCH",{blocked_message:e}),a=this.items.findIndex(s=>s.id===t);return a!==-1&&(this.items[a]=i),i},async unblock(t){const{data:e}=await d(`${m}/${t}/unblock`,"PATCH"),i=this.items.findIndex(a=>a.id===t);return i!==-1&&(this.items[i]=e),e}}}),D={name:"RegistrationVideoForm",data(){return{userStore:E(),activeTab:"form",formCompleted:!1,dragActive:!1,form:{surname:"",name:"",patronymic:"",city:"",region:"",birthday:"",agreeWithRules:!1,agreeUseVideo:!1},videoFile:null}},computed:{tg(){return window.Telegram.WebApp},self(){return this.userStore.self}},created(){this.userStore.fetchSelf().then(()=>{let t=(this.self.name||"").split(" ");t.length<=1&&(t=this.self.fio_from_telegram.split(" ")),this.form.name=t[0]||"",this.form.patronymic=t[1]||"",this.form.surname=t[2]||"",this.form.city=this.self.city||"",this.form.region=this.self.region||"",this.form.birthday=this.self.birthday||""})},methods:{openRules(){},submitForm(){if(this.activeTab==="form"){this.activeTab="upload";return}this.userStore.uploadFormWithVideo(this.form,this.videoFile).then(()=>{this.tg.close()}),this.formCompleted=!0},handleDrop(t){this.dragActive=!1;const e=t.dataTransfer.files[0];e&&e.type.startsWith("video/")&&(this.videoFile=e)},handleFileSelect(t){const e=t.target.files[0];e&&e.type.startsWith("video/")&&(this.videoFile=e)},submitVideo(){}}},C={key:0,class:"container py-4"},W={class:"form-floating mb-2"},O={class:"form-floating mb-2"},I={class:"form-floating mb-2"},R={class:"form-floating mb-2"},G={class:"form-floating mb-2"},j={class:"form-floating mb-2"},q={class:"form-check mb-2"},B={class:"form-check mb-2"},M=["disabled"],L=["disabled"],N={key:0,class:"mt-3"},H={class:"text-break"},z={class:"w-100 mb-2",style:{background:"#eee",height:"10px","border-radius":"4px"}},X={class:"fst-italic"},J={class:"fw-bold"},K=["disabled"],Q=["disabled"],Y={key:0},Z={key:0},$={key:1};function ee(t,e,i,a,s,n){return n.self?(u(),f("div",C,[e[27]||(e[27]=r("div",{class:"text-center mb-4"},[r("img",{src:"/пнглого.png",alt:"logo",style:{"max-width":"160px"}})],-1)),r("form",{onSubmit:e[14]||(e[14]=w((...o)=>n.submitForm&&n.submitForm(...o),["prevent"]))},[s.activeTab==="form"?(u(),f(v,{key:0},[r("div",W,[c(r("input",{type:"text",class:"form-control",id:"surname",placeholder:"Фамилия","onUpdate:modelValue":e[0]||(e[0]=o=>s.form.surname=o),required:""},null,512),[[g,s.form.surname]]),e[15]||(e[15]=r("label",{for:"surname"},"Фамилия",-1))]),r("div",O,[c(r("input",{type:"text",class:"form-control",id:"name",placeholder:"Имя","onUpdate:modelValue":e[1]||(e[1]=o=>s.form.name=o),required:""},null,512),[[g,s.form.name]]),e[16]||(e[16]=r("label",{for:"name"},"Имя",-1))]),r("div",I,[c(r("input",{type:"text",class:"form-control",id:"patronymic",placeholder:"Отчество","onUpdate:modelValue":e[2]||(e[2]=o=>s.form.patronymic=o)},null,512),[[g,s.form.patronymic]]),e[17]||(e[17]=r("label",{for:"patronymic"},"Отчество",-1))]),r("div",R,[c(r("input",{type:"date",class:"form-control",id:"birthday",placeholder:"Дата рождения","onUpdate:modelValue":e[3]||(e[3]=o=>s.form.birthday=o),required:""},null,512),[[g,s.form.birthday]]),e[18]||(e[18]=r("label",{for:"birthday"},"Дата рождения",-1))]),r("div",G,[c(r("input",{type:"text",class:"form-control",id:"region",placeholder:"Регион","onUpdate:modelValue":e[4]||(e[4]=o=>s.form.region=o),required:""},null,512),[[g,s.form.region]]),e[19]||(e[19]=r("label",{for:"region"},"Регион",-1))]),r("div",j,[c(r("input",{type:"text",class:"form-control",id:"city",placeholder:"Город","onUpdate:modelValue":e[5]||(e[5]=o=>s.form.city=o),required:""},null,512),[[g,s.form.city]]),e[20]||(e[20]=r("label",{for:"city"},"Город",-1))]),r("div",q,[c(r("input",{class:"form-check-input",type:"checkbox",id:"agree","onUpdate:modelValue":e[6]||(e[6]=o=>s.form.agreeWithRules=o),required:""},null,512),[[S,s.form.agreeWithRules]]),e[21]||(e[21]=r("label",{class:"form-check-label",for:"agree"}," Я даю своё согласие на обработку персональных данных ",-1))]),r("div",B,[c(r("input",{class:"form-check-input",type:"checkbox",id:"agree","onUpdate:modelValue":e[7]||(e[7]=o=>s.form.agreeUseVideo=o),required:""},null,512),[[S,s.form.agreeUseVideo]]),e[22]||(e[22]=r("label",{class:"form-check-label",for:"agree"}," Я даю своё согласие на использование загруженных мною видео-роликов в целях реализации акции «Моё слово защитнику» ",-1))]),r("button",{disabled:!s.form.agreeWithRules||!s.form.agreeUseVideo,class:"btn btn-primary w-100 p-3",type:"submit"}," Продолжить ",8,M)],64)):p("",!0),s.activeTab==="upload"?(u(),f(v,{key:1},[r("div",{class:F(["upload-area border rounded p-4 text-center mb-2",{"upload-area--active":s.dragActive}]),onDragover:e[10]||(e[10]=w(o=>s.dragActive=!0,["prevent"])),onDragleave:e[11]||(e[11]=w(o=>s.dragActive=!1,["prevent"])),onDrop:e[12]||(e[12]=w((...o)=>n.handleDrop&&n.handleDrop(...o),["prevent"]))},[e[24]||(e[24]=r("p",{class:"mb-2 fw-bold"},"Перетащите видео сюда",-1)),e[25]||(e[25]=r("p",{class:"text-muted"},"или нажмите, чтобы выбрать файл",-1)),r("input",{type:"file",accept:"video/*",class:"d-none",ref:"fileInput",onChange:e[8]||(e[8]=(...o)=>n.handleFileSelect&&n.handleFileSelect(...o))},null,544),r("button",{disabled:s.userStore.loading,type:"button",class:"btn btn-outline-secondary mt-2",onClick:e[9]||(e[9]=o=>t.$refs.fileInput.click())}," Выбрать файл ",8,L),s.videoFile?(u(),f("div",N,[e[23]||(e[23]=r("p",{class:"fw-semibold"},"Вы выбрали:",-1)),r("p",H,k(s.videoFile.name),1)])):p("",!0)],34),s.userStore.progress>0?(u(),f(v,{key:0},[r("div",z,[r("div",{style:_({width:s.userStore.progress+"%",background:"#42b883",height:"10px",borderRadius:"4px"})},null,4)]),r("p",X,[e[26]||(e[26]=P("Уже загружено ",-1)),r("span",J,k(s.userStore.progress)+"%",1)])],64)):p("",!0),r("button",{onClick:e[13]||(e[13]=o=>s.activeTab="form"),disabled:s.userStore.loading,class:"btn btn-outline-light w-100 p-3 mb-2 text-secondary",type:"button"}," Редактировать информацию ",8,K),r("button",{type:"submit",class:"btn btn-success w-100 p-3",disabled:!s.videoFile||s.userStore.loading},[s.videoFile?p("",!0):(u(),f("span",Y,"Выберите видео для отправки")),s.videoFile?(u(),f(v,{key:1},[s.userStore.loading?(u(),f("span",Z,"Видео загружается...")):(u(),f("span",$,"Отправить видео"))],64)):p("",!0)],8,Q)],64)):p("",!0)],32)])):p("",!0)}const te=A(D,[["render",ee],["__scopeId","data-v-a24ef871"]]),se={data(){return{tab:"main"}},methods:{}},re=Object.assign(se,{__name:"MenuUser",setup(t){return(e,i)=>(u(),V(te))}}),oe={class:"container-fluid p-3"},ie={data(){return{}},computed:{tg(){return window.Telegram.WebApp}},methods:{}},le=Object.assign(ie,{__name:"MenuPage",setup(t){return(e,i)=>(u(),f("div",oe,[U(re)]))}});export{le as default};
