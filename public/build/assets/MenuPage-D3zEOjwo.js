import{u as S,j as p,f as T,b as u,d as f,o as c,a as r,F as y,k as g,v,l as _,e as k,m as w,n as F,t as x,p as P,c as A,h as E}from"./app-CA5tdD-4.js";import{_ as D}from"./_plugin-vue_export-helper-DlAUqK2U.js";async function d(t,e="GET",o=null,a=null){var i,b;if(!navigator.onLine)return S().show("Вы не в сети!"),Promise.reject("Вы не в сети!");const s=((i=window.Telegram)==null?void 0:i.WebApp.initData)||null;p.defaults.headers.common["X-TG-DATA"]=s?btoa(s):null;const n=S();try{let l,h=!1;switch(e.toUpperCase()){case"POST":l=await p.post(t,o,a||void 0);break;case"PUT":h=!0,l=await p.put(t,o);break;case"DELETE":h=!0,l=await p.delete(t);break;case"GET":default:l=await p.get(t,a||void 0);break}return h&&n.show("Операция выполнена успешно","success"),l}catch(l){return((b=l==null?void 0:l.response)==null?void 0:b.status)===419?(n.show("Сессия истекла, страница будет перезагружена","warning"),window.location.reload(),Promise.reject("Сессия истекла")):(n.show(`Ошибка: ${(l==null?void 0:l.message)||"Неизвестная ошибка"}`),Promise.reject(l))}}const m="/bot-api/users",V=T("users",{state:()=>({items:[],self:null,loading:!1,progress:0,error:null}),getters:{byId:t=>e=>t.items.find(o=>o.id===e)},actions:{setRole(t){this.self.role=t},async fetchSelf(){this.loading=!0,this.error=null;try{const{data:t}=await d(`${m}/self`,"POST");this.self=t}catch(t){this.error=(t==null?void 0:t.message)||"Failed to load agents"}finally{this.loading=!1}return!0},async fetchFiltered(t=1){var e,o;this.loading=!0,this.error=null;try{const a=new URLSearchParams;Object.entries(this.filters).forEach(([n,i])=>{i!=null&&i!==""&&i!==!1&&a.append(n,String(i))}),a.append("sort_field",this.sort.field),a.append("sort_direction",this.sort.direction),a.append("page",String(t));const{data:s}=await d(`${m}?${a.toString()}`,"GET");this.items=s.data,this.pagination=s}catch(a){this.error=((o=(e=a.response)==null?void 0:e.data)==null?void 0:o.message)??"Ошибка загрузки пользователей"}finally{this.loading=!1}},setFilters(t){this.filters=t},setSort(t,e){this.sort={field:t,direction:e}},async fetchAll(){this.loading=!0,this.error=null;try{const{data:t}=await d(`${m}`,"GET");this.items=t.data,console.log("data=>",t)}catch(t){this.error=(t==null?void 0:t.message)||"Failed to load users"}finally{this.loading=!1}},async fetchAllByPage(t=1){const{data:e}=await d(`${m}?page=${t}`,"GET");this.items=e.data,this.pagination=e},async fetchByUrl(t){const{data:e}=await d(t,"GET");this.items=e.data,this.pagination=e},async fetchOne(t){try{const{data:e}=await d(`${m}/${t}`,"GET");return e}catch(e){throw this.error=(e==null?void 0:e.message)||"Failed to load user",e}},async uploadFormWithVideo(t,e){var a,s;this.loading=!0,this.error=null;const o=S();o.show("Загрузка файла началась");try{const n=new FormData;Object.entries(t).forEach(([l,h])=>{n.append(l,h)}),n.append("file",e),p.defaults.adapter="xhr";const{data:i}=await p.post(`${m}/send-video`,n,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:l=>{l.total&&(this.progress=Math.round(l.loaded*100/l.total))}});let b=i.message||"Файл успешно загружен";o.show(b,"success")}catch(n){const i=n;this.error=((s=(a=i.response)==null?void 0:a.data)==null?void 0:s.message)||"Ошибка при загрузке файла",o.show(this.error,"error")}finally{this.loading=!1}},async createPrimary(t){const{data:e}=await d(`${m}/primary`,"POST",t);return this.items.push(e),e},async create(t){const{data:e}=await d(`${m}`,"POST",t);return this.items.push(e),e},async update(t,e){const{data:o}=await d(`${m}/${t}`,"PUT",e),a=this.items.findIndex(s=>s.id===t);return a!==-1&&(this.items[a]=o),o},async remove(t){await d(`${m}/${t}`,"DELETE"),this.items=this.items.filter(e=>e.id!==t)},async getTelegramLink(t){await d(`${m}/${t}/tg`,"GET")},async updateRole(t,e){const{data:o}=await d(`${m}/${t}/role`,"POST",{role:e}),a=this.items.findIndex(s=>s.id===t);return a!==-1&&(this.items[a]=o),o},async updatePercent(t,e){const{data:o}=await d(`${m}/${t}/percent`,"PATCH",{percent:e}),a=this.items.findIndex(s=>s.id===t);return a!==-1&&(this.items[a]=o),o},async updateWorkStatus(t,e){const o=S(),{data:a}=await d(`${m}/${t}/work-status`,"POST",{is_work:e});o.show("Статус успешно обновлен");const s=this.items.findIndex(n=>n.id===t);return s!==-1&&(this.items[s]=a),a},async block(t,e){const{data:o}=await d(`${m}/${t}/block`,"PATCH",{blocked_message:e}),a=this.items.findIndex(s=>s.id===t);return a!==-1&&(this.items[a]=o),o},async unblock(t){const{data:e}=await d(`${m}/${t}/unblock`,"PATCH"),o=this.items.findIndex(a=>a.id===t);return o!==-1&&(this.items[o]=e),e}}}),C={name:"RegistrationVideoForm",data(){return{userStore:V(),activeTab:"form",formCompleted:!1,dragActive:!1,form:{surname:"",name:"",patronymic:"",city:"",agree:!1},videoFile:null}},computed:{tg(){return window.Telegram.WebApp},self(){return this.userStore.self}},created(){this.userStore.fetchSelf().then(()=>{let t=(this.self.name||"").split(" ");t.length<=1&&(t=this.self.fio_from_telegram.split(" ")),this.form.name=t[0]||"",this.form.patronymic=t[1]||"",this.form.surname=t[2]||"",this.form.city=this.self.city||""})},methods:{openRules(){},submitForm(){if(this.activeTab==="form"){this.activeTab="upload";return}this.userStore.uploadFormWithVideo(this.form,this.videoFile).then(()=>{this.tg.close()}),this.formCompleted=!0},handleDrop(t){this.dragActive=!1;const e=t.dataTransfer.files[0];e&&e.type.startsWith("video/")&&(this.videoFile=e)},handleFileSelect(t){const e=t.target.files[0];e&&e.type.startsWith("video/")&&(this.videoFile=e)},submitVideo(){}}},U={key:0,class:"container py-4"},O={class:"form-floating mb-2"},I={class:"form-floating mb-2"},G={class:"form-floating mb-2"},j={class:"form-floating mb-2"},W={class:"form-check mb-2"},B=["disabled"],M=["disabled"],R={key:0,class:"mt-3"},L={class:"text-break"},N={class:"w-100 mb-2",style:{background:"#eee",height:"10px","border-radius":"4px"}},$={class:"fst-italic"},q={class:"fw-bold"},H=["disabled"],z=["disabled"],X={key:0},J={key:0},K={key:1};function Q(t,e,o,a,s,n){return n.self?(c(),u("div",U,[e[22]||(e[22]=r("div",{class:"text-center mb-4"},[r("img",{src:"/logo.png",alt:"logo",style:{"max-width":"160px"}})],-1)),r("form",{onSubmit:e[11]||(e[11]=w((...i)=>n.submitForm&&n.submitForm(...i),["prevent"]))},[s.activeTab==="form"?(c(),u(y,{key:0},[e[17]||(e[17]=r("div",{class:"my-4 text-center"},[r("a",{href:"https://telegra.ph/Pravila-konkursa-01-27",target:"_blank",class:"btn btn-outline-primary"}," Правила участия ")],-1)),r("div",O,[g(r("input",{type:"text",class:"form-control",id:"surname",placeholder:"Фамилия","onUpdate:modelValue":e[0]||(e[0]=i=>s.form.surname=i),required:""},null,512),[[v,s.form.surname]]),e[12]||(e[12]=r("label",{for:"surname"},"Фамилия",-1))]),r("div",I,[g(r("input",{type:"text",class:"form-control",id:"name",placeholder:"Имя","onUpdate:modelValue":e[1]||(e[1]=i=>s.form.name=i),required:""},null,512),[[v,s.form.name]]),e[13]||(e[13]=r("label",{for:"name"},"Имя",-1))]),r("div",G,[g(r("input",{type:"text",class:"form-control",id:"patronymic",placeholder:"Отчество","onUpdate:modelValue":e[2]||(e[2]=i=>s.form.patronymic=i)},null,512),[[v,s.form.patronymic]]),e[14]||(e[14]=r("label",{for:"patronymic"},"Отчество",-1))]),r("div",j,[g(r("input",{type:"text",class:"form-control",id:"city",placeholder:"Город","onUpdate:modelValue":e[3]||(e[3]=i=>s.form.city=i),required:""},null,512),[[v,s.form.city]]),e[15]||(e[15]=r("label",{for:"city"},"Город",-1))]),r("div",W,[g(r("input",{class:"form-check-input",type:"checkbox",id:"agree","onUpdate:modelValue":e[4]||(e[4]=i=>s.form.agree=i),required:""},null,512),[[_,s.form.agree]]),e[16]||(e[16]=r("label",{class:"form-check-label",for:"agree"},[k(" Я ознакомлен с "),r("a",{href:"https://telegra.ph/Politika-konfidencialnosti-01-27-76",target:"_blank"},"правилами сервиса"),k(" и даю согласие на использование видео и обработку персональных данных ")],-1))]),r("button",{disabled:!s.form.agree,class:"btn btn-primary w-100 p-3",type:"submit"}," Продолжить ",8,B)],64)):f("",!0),s.activeTab==="upload"?(c(),u(y,{key:1},[r("div",{class:F(["upload-area border rounded p-4 text-center mb-2",{"upload-area--active":s.dragActive}]),onDragover:e[7]||(e[7]=w(i=>s.dragActive=!0,["prevent"])),onDragleave:e[8]||(e[8]=w(i=>s.dragActive=!1,["prevent"])),onDrop:e[9]||(e[9]=w((...i)=>n.handleDrop&&n.handleDrop(...i),["prevent"]))},[e[19]||(e[19]=r("p",{class:"mb-2 fw-bold"},"Перетащите видео сюда",-1)),e[20]||(e[20]=r("p",{class:"text-muted"},"или нажмите, чтобы выбрать файл",-1)),r("input",{type:"file",accept:"video/*",class:"d-none",ref:"fileInput",onChange:e[5]||(e[5]=(...i)=>n.handleFileSelect&&n.handleFileSelect(...i))},null,544),r("button",{disabled:s.userStore.loading,type:"button",class:"btn btn-outline-secondary mt-2",onClick:e[6]||(e[6]=i=>t.$refs.fileInput.click())}," Выбрать файл ",8,M),s.videoFile?(c(),u("div",R,[e[18]||(e[18]=r("p",{class:"fw-semibold"},"Вы выбрали:",-1)),r("p",L,x(s.videoFile.name),1)])):f("",!0)],34),s.userStore.progress>0?(c(),u(y,{key:0},[r("div",N,[r("div",{style:P({width:s.userStore.progress+"%",background:"#42b883",height:"10px",borderRadius:"4px"})},null,4)]),r("p",$,[e[21]||(e[21]=k("Уже загружено ",-1)),r("span",q,x(s.userStore.progress)+"%",1)])],64)):f("",!0),r("button",{onClick:e[10]||(e[10]=i=>s.activeTab="form"),disabled:s.userStore.loading,class:"btn btn-outline-light w-100 p-3 mb-2 text-secondary",type:"button"}," Редактировать информацию ",8,H),r("button",{type:"submit",class:"btn btn-success w-100 p-3",disabled:!s.videoFile||s.userStore.loading},[s.videoFile?f("",!0):(c(),u("span",X,"Выберите видео для отправки")),s.videoFile?(c(),u(y,{key:1},[s.userStore.loading?(c(),u("span",J,"Видео загружается...")):(c(),u("span",K,"Отправить видео"))],64)):f("",!0)],8,z)],64)):f("",!0)],32)])):f("",!0)}const Y=D(C,[["render",Q],["__scopeId","data-v-90469581"]]),Z={data(){return{tab:"main"}},methods:{}},ee=Object.assign(Z,{__name:"MenuUser",setup(t){return(e,o)=>(c(),A(Y))}}),te={class:"container-fluid p-3"},se={data(){return{}},computed:{tg(){return window.Telegram.WebApp}},methods:{}},oe=Object.assign(se,{__name:"MenuPage",setup(t){return(e,o)=>(c(),u("div",te,[E(ee)]))}});export{oe as default};
