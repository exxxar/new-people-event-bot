import{u as w,j as f,f as S,b as h,d as g,o as c,a as r,n as T,F as k,k as p,v as y,l as F,e as x,m as v,t as P,c as _,h as A}from"./app-CuF2DeWQ.js";import{_ as E}from"./_plugin-vue_export-helper-DlAUqK2U.js";async function d(e,t="GET",a=null,o=null){var i,b;if(!navigator.onLine)return w().show("Вы не в сети!"),Promise.reject("Вы не в сети!");const s=((i=window.Telegram)==null?void 0:i.WebApp.initData)||null;f.defaults.headers.common["X-TG-DATA"]=s?btoa(s):null;const n=w();try{let l,u=!1;switch(t.toUpperCase()){case"POST":l=await f.post(e,a,o||void 0);break;case"PUT":u=!0,l=await f.put(e,a);break;case"DELETE":u=!0,l=await f.delete(e);break;case"GET":default:l=await f.get(e,o||void 0);break}return u&&n.show("Операция выполнена успешно","success"),l}catch(l){return((b=l==null?void 0:l.response)==null?void 0:b.status)===419?(n.show("Сессия истекла, страница будет перезагружена","warning"),window.location.reload(),Promise.reject("Сессия истекла")):(n.show(`Ошибка: ${(l==null?void 0:l.message)||"Неизвестная ошибка"}`),Promise.reject(l))}}const m="/bot-api/users",C=S("users",{state:()=>({items:[],self:null,loading:!1,error:null}),getters:{byId:e=>t=>e.items.find(a=>a.id===t)},actions:{setRole(e){this.self.role=e},async fetchSelf(){this.loading=!0,this.error=null;try{const{data:e}=await d(`${m}/self`,"POST");this.self=e}catch(e){this.error=(e==null?void 0:e.message)||"Failed to load agents"}finally{this.loading=!1}return!0},async fetchFiltered(e=1){var t,a;this.loading=!0,this.error=null;try{const o=new URLSearchParams;Object.entries(this.filters).forEach(([n,i])=>{i!=null&&i!==""&&i!==!1&&o.append(n,String(i))}),o.append("sort_field",this.sort.field),o.append("sort_direction",this.sort.direction),o.append("page",String(e));const{data:s}=await d(`${m}?${o.toString()}`,"GET");this.items=s.data,this.pagination=s}catch(o){this.error=((a=(t=o.response)==null?void 0:t.data)==null?void 0:a.message)??"Ошибка загрузки пользователей"}finally{this.loading=!1}},setFilters(e){this.filters=e},setSort(e,t){this.sort={field:e,direction:t}},async fetchAll(){this.loading=!0,this.error=null;try{const{data:e}=await d(`${m}`,"GET");this.items=e.data,console.log("data=>",e)}catch(e){this.error=(e==null?void 0:e.message)||"Failed to load users"}finally{this.loading=!1}},async fetchAllByPage(e=1){const{data:t}=await d(`${m}?page=${e}`,"GET");this.items=t.data,this.pagination=t},async fetchByUrl(e){const{data:t}=await d(e,"GET");this.items=t.data,this.pagination=t},async fetchOne(e){try{const{data:t}=await d(`${m}/${e}`,"GET");return t}catch(t){throw this.error=(t==null?void 0:t.message)||"Failed to load user",t}},async uploadFormWithVideo(e,t){var o,s;this.loading=!0,this.error=null;const a=w();a.show("Загрузка файла началась");try{const n=new FormData;Object.entries(e).forEach(([l,u])=>{n.append(l,u)}),n.append("file",t);const{data:i}=await axios.post(`${m}/send-video`,n,{headers:{"Content-Type":"multipart/form-data"}});let b=i.message||"Файл успешно загружен";a.show(b,"success")}catch(n){const i=n;this.error=((s=(o=i.response)==null?void 0:o.data)==null?void 0:s.message)||"Ошибка при загрузке файла",a.show(this.error,"error")}finally{this.loading=!1}},async createPrimary(e){const{data:t}=await d(`${m}/primary`,"POST",e);return this.items.push(t),t},async create(e){const{data:t}=await d(`${m}`,"POST",e);return this.items.push(t),t},async update(e,t){const{data:a}=await d(`${m}/${e}`,"PUT",t),o=this.items.findIndex(s=>s.id===e);return o!==-1&&(this.items[o]=a),a},async remove(e){await d(`${m}/${e}`,"DELETE"),this.items=this.items.filter(t=>t.id!==e)},async getTelegramLink(e){await d(`${m}/${e}/tg`,"GET")},async updateRole(e,t){const{data:a}=await d(`${m}/${e}/role`,"POST",{role:t}),o=this.items.findIndex(s=>s.id===e);return o!==-1&&(this.items[o]=a),a},async updatePercent(e,t){const{data:a}=await d(`${m}/${e}/percent`,"PATCH",{percent:t}),o=this.items.findIndex(s=>s.id===e);return o!==-1&&(this.items[o]=a),a},async updateWorkStatus(e,t){const a=w(),{data:o}=await d(`${m}/${e}/work-status`,"POST",{is_work:t});a.show("Статус успешно обновлен");const s=this.items.findIndex(n=>n.id===e);return s!==-1&&(this.items[s]=o),o},async block(e,t){const{data:a}=await d(`${m}/${e}/block`,"PATCH",{blocked_message:t}),o=this.items.findIndex(s=>s.id===e);return o!==-1&&(this.items[o]=a),a},async unblock(e){const{data:t}=await d(`${m}/${e}/unblock`,"PATCH"),a=this.items.findIndex(o=>o.id===e);return a!==-1&&(this.items[a]=t),t}}}),D={name:"RegistrationVideoForm",data(){return{userStore:C(),activeTab:"form",formCompleted:!1,dragActive:!1,form:{surname:"",name:"",patronymic:"",city:"",agree:!1},videoFile:null}},computed:{tg(){return window.Telegram.WebApp},self(){return this.userStore.self}},created(){this.userStore.fetchSelf().then(()=>{const e=this.self.fio_from_telegram.split(" ");this.form.name=e[0],this.form.patronymic=e[2],this.form.surname=e[1]})},methods:{openRules(){},submitForm(){if(this.activeTab==="form"){this.activeTab="upload";return}this.userStore.uploadFormWithVideo(this.form,this.videoFile).then(()=>{this.tg.close()}),this.formCompleted=!0},handleDrop(e){this.dragActive=!1;const t=e.dataTransfer.files[0];t&&t.type.startsWith("video/")&&(this.videoFile=t)},handleFileSelect(e){const t=e.target.files[0];t&&t.type.startsWith("video/")&&(this.videoFile=t)},submitVideo(){}}},V={key:0,class:"container py-4"},U={class:"nav nav-tabs mb-2"},O={class:"nav-item"},$={class:"nav-item"},I={class:"form-floating mb-2"},G={class:"form-floating mb-2"},j={class:"form-floating mb-2"},W={class:"form-floating mb-2"},B={class:"form-check mb-2"},L=["disabled"],M={key:0,class:"mt-3"},N=["disabled"];function R(e,t,a,o,s,n){return n.self?(c(),h("div",V,[t[22]||(t[22]=r("div",{class:"text-center mb-4"},[r("img",{src:"/logo.png",alt:"logo",style:{"max-width":"160px"}})],-1)),r("ul",U,[r("li",O,[r("button",{class:T(["nav-link",{active:s.activeTab==="form"}]),onClick:t[0]||(t[0]=i=>s.activeTab="form")}," Регистрация ",2)]),r("li",$,[r("button",{class:T(["nav-link",{active:s.activeTab==="upload",disabled:!s.formCompleted}]),onClick:t[1]||(t[1]=i=>s.formCompleted&&(s.activeTab="upload"))}," Загрузка видео ",2)])]),r("form",{onSubmit:t[12]||(t[12]=v((...i)=>n.submitForm&&n.submitForm(...i),["prevent"]))},[s.activeTab==="form"?(c(),h(k,{key:0},[t[18]||(t[18]=r("div",{class:"my-4 text-center"},[r("a",{href:"https://telegra.ph/Pravila-konkursa-01-27",target:"_blank",class:"btn btn-outline-primary"}," Правила участия ")],-1)),r("div",I,[p(r("input",{type:"text",class:"form-control",id:"surname",placeholder:"Фамилия","onUpdate:modelValue":t[2]||(t[2]=i=>s.form.surname=i),required:""},null,512),[[y,s.form.surname]]),t[13]||(t[13]=r("label",{for:"surname"},"Фамилия",-1))]),r("div",G,[p(r("input",{type:"text",class:"form-control",id:"name",placeholder:"Имя","onUpdate:modelValue":t[3]||(t[3]=i=>s.form.name=i),required:""},null,512),[[y,s.form.name]]),t[14]||(t[14]=r("label",{for:"name"},"Имя",-1))]),r("div",j,[p(r("input",{type:"text",class:"form-control",id:"patronymic",placeholder:"Отчество","onUpdate:modelValue":t[4]||(t[4]=i=>s.form.patronymic=i)},null,512),[[y,s.form.patronymic]]),t[15]||(t[15]=r("label",{for:"patronymic"},"Отчество",-1))]),r("div",W,[p(r("input",{type:"text",class:"form-control",id:"city",placeholder:"Город","onUpdate:modelValue":t[5]||(t[5]=i=>s.form.city=i),required:""},null,512),[[y,s.form.city]]),t[16]||(t[16]=r("label",{for:"city"},"Город",-1))]),r("div",B,[p(r("input",{class:"form-check-input",type:"checkbox",id:"agree","onUpdate:modelValue":t[6]||(t[6]=i=>s.form.agree=i),required:""},null,512),[[F,s.form.agree]]),t[17]||(t[17]=r("label",{class:"form-check-label",for:"agree"},[x(" Я ознакомлен с "),r("a",{href:"https://telegra.ph/Politika-konfidencialnosti-01-27-76",target:"_blank"},"правилами сервиса"),x(" и даю согласие на использование видео и обработку персональных данных ")],-1))]),r("button",{disabled:!s.form.agree,class:"btn btn-primary w-100 p-3",type:"submit"}," Продолжить ",8,L)],64)):g("",!0),s.activeTab==="upload"?(c(),h(k,{key:1},[r("div",{class:T(["upload-area border rounded p-4 text-center mb-2",{"upload-area--active":s.dragActive}]),onDragover:t[9]||(t[9]=v(i=>s.dragActive=!0,["prevent"])),onDragleave:t[10]||(t[10]=v(i=>s.dragActive=!1,["prevent"])),onDrop:t[11]||(t[11]=v((...i)=>n.handleDrop&&n.handleDrop(...i),["prevent"]))},[t[20]||(t[20]=r("p",{class:"mb-2 fw-bold"},"Перетащите видео сюда",-1)),t[21]||(t[21]=r("p",{class:"text-muted"},"или нажмите, чтобы выбрать файл",-1)),r("input",{type:"file",accept:"video/*",class:"d-none",ref:"fileInput",onChange:t[7]||(t[7]=(...i)=>n.handleFileSelect&&n.handleFileSelect(...i))},null,544),r("button",{type:"button",class:"btn btn-outline-secondary mt-2",onClick:t[8]||(t[8]=i=>e.$refs.fileInput.click())}," Выбрать файл "),s.videoFile?(c(),h("div",M,[t[19]||(t[19]=r("p",{class:"fw-semibold"},"Вы выбрали:",-1)),r("p",null,P(s.videoFile.name),1)])):g("",!0)],34),r("button",{type:"submit",class:"btn btn-success w-100 p-3",disabled:!s.videoFile}," Отправить видео ",8,N)],64)):g("",!0)],32)])):g("",!0)}const q=E(D,[["render",R],["__scopeId","data-v-47a7cb31"]]),H={data(){return{tab:"main"}},methods:{}},z=Object.assign(H,{__name:"MenuUser",setup(e){return(t,a)=>(c(),_(q))}}),X={class:"container-fluid p-3"},J={data(){return{}},computed:{tg(){return window.Telegram.WebApp}},methods:{}},Y=Object.assign(J,{__name:"MenuPage",setup(e){return(t,a)=>(c(),h("div",X,[A(z)]))}});export{Y as default};
