import{u as w,j as f,f as S,b as h,d as b,o as c,a as o,F as T,k as p,v as y,l as k,e as x,m as v,n as F,t as P,c as A,h as E}from"./app-B87-pTob.js";import{_}from"./_plugin-vue_export-helper-DlAUqK2U.js";async function d(e,t="GET",i=null,a=null){var r,g;if(!navigator.onLine)return w().show("Вы не в сети!"),Promise.reject("Вы не в сети!");const s=((r=window.Telegram)==null?void 0:r.WebApp.initData)||null;f.defaults.headers.common["X-TG-DATA"]=s?btoa(s):null;const n=w();try{let l,u=!1;switch(t.toUpperCase()){case"POST":l=await f.post(e,i,a||void 0);break;case"PUT":u=!0,l=await f.put(e,i);break;case"DELETE":u=!0,l=await f.delete(e);break;case"GET":default:l=await f.get(e,a||void 0);break}return u&&n.show("Операция выполнена успешно","success"),l}catch(l){return((g=l==null?void 0:l.response)==null?void 0:g.status)===419?(n.show("Сессия истекла, страница будет перезагружена","warning"),window.location.reload(),Promise.reject("Сессия истекла")):(n.show(`Ошибка: ${(l==null?void 0:l.message)||"Неизвестная ошибка"}`),Promise.reject(l))}}const m="/bot-api/users",D=S("users",{state:()=>({items:[],self:null,loading:!1,error:null}),getters:{byId:e=>t=>e.items.find(i=>i.id===t)},actions:{setRole(e){this.self.role=e},async fetchSelf(){this.loading=!0,this.error=null;try{const{data:e}=await d(`${m}/self`,"POST");this.self=e}catch(e){this.error=(e==null?void 0:e.message)||"Failed to load agents"}finally{this.loading=!1}return!0},async fetchFiltered(e=1){var t,i;this.loading=!0,this.error=null;try{const a=new URLSearchParams;Object.entries(this.filters).forEach(([n,r])=>{r!=null&&r!==""&&r!==!1&&a.append(n,String(r))}),a.append("sort_field",this.sort.field),a.append("sort_direction",this.sort.direction),a.append("page",String(e));const{data:s}=await d(`${m}?${a.toString()}`,"GET");this.items=s.data,this.pagination=s}catch(a){this.error=((i=(t=a.response)==null?void 0:t.data)==null?void 0:i.message)??"Ошибка загрузки пользователей"}finally{this.loading=!1}},setFilters(e){this.filters=e},setSort(e,t){this.sort={field:e,direction:t}},async fetchAll(){this.loading=!0,this.error=null;try{const{data:e}=await d(`${m}`,"GET");this.items=e.data,console.log("data=>",e)}catch(e){this.error=(e==null?void 0:e.message)||"Failed to load users"}finally{this.loading=!1}},async fetchAllByPage(e=1){const{data:t}=await d(`${m}?page=${e}`,"GET");this.items=t.data,this.pagination=t},async fetchByUrl(e){const{data:t}=await d(e,"GET");this.items=t.data,this.pagination=t},async fetchOne(e){try{const{data:t}=await d(`${m}/${e}`,"GET");return t}catch(t){throw this.error=(t==null?void 0:t.message)||"Failed to load user",t}},async uploadFormWithVideo(e,t){var a,s;this.loading=!0,this.error=null;const i=w();i.show("Загрузка файла началась");try{const n=new FormData;Object.entries(e).forEach(([l,u])=>{n.append(l,u)}),n.append("file",t);const{data:r}=await axios.post(`${m}/send-video`,n,{headers:{"Content-Type":"multipart/form-data"}});let g=r.message||"Файл успешно загружен";i.show(g,"success")}catch(n){const r=n;this.error=((s=(a=r.response)==null?void 0:a.data)==null?void 0:s.message)||"Ошибка при загрузке файла",i.show(this.error,"error")}finally{this.loading=!1}},async createPrimary(e){const{data:t}=await d(`${m}/primary`,"POST",e);return this.items.push(t),t},async create(e){const{data:t}=await d(`${m}`,"POST",e);return this.items.push(t),t},async update(e,t){const{data:i}=await d(`${m}/${e}`,"PUT",t),a=this.items.findIndex(s=>s.id===e);return a!==-1&&(this.items[a]=i),i},async remove(e){await d(`${m}/${e}`,"DELETE"),this.items=this.items.filter(t=>t.id!==e)},async getTelegramLink(e){await d(`${m}/${e}/tg`,"GET")},async updateRole(e,t){const{data:i}=await d(`${m}/${e}/role`,"POST",{role:t}),a=this.items.findIndex(s=>s.id===e);return a!==-1&&(this.items[a]=i),i},async updatePercent(e,t){const{data:i}=await d(`${m}/${e}/percent`,"PATCH",{percent:t}),a=this.items.findIndex(s=>s.id===e);return a!==-1&&(this.items[a]=i),i},async updateWorkStatus(e,t){const i=w(),{data:a}=await d(`${m}/${e}/work-status`,"POST",{is_work:t});i.show("Статус успешно обновлен");const s=this.items.findIndex(n=>n.id===e);return s!==-1&&(this.items[s]=a),a},async block(e,t){const{data:i}=await d(`${m}/${e}/block`,"PATCH",{blocked_message:t}),a=this.items.findIndex(s=>s.id===e);return a!==-1&&(this.items[a]=i),i},async unblock(e){const{data:t}=await d(`${m}/${e}/unblock`,"PATCH"),i=this.items.findIndex(a=>a.id===e);return i!==-1&&(this.items[i]=t),t}}}),$={name:"RegistrationVideoForm",data(){return{userStore:D(),activeTab:"form",formCompleted:!1,dragActive:!1,form:{surname:"",name:"",patronymic:"",city:"",agree:!1},videoFile:null}},computed:{tg(){return window.Telegram.WebApp},self(){return this.userStore.self}},created(){this.userStore.fetchSelf().then(()=>{let e=this.self.name.split(" ");e.length<=1&&(e=this.self.fio_from_telegram.split(" ")),this.form.name=e[0]||"",this.form.patronymic=e[1]||"",this.form.surname=e[2]||"",this.form.city=this.self.city||""})},methods:{openRules(){},submitForm(){if(this.activeTab==="form"){this.activeTab="upload";return}this.userStore.uploadFormWithVideo(this.form,this.videoFile).then(()=>{this.tg.close()}),this.formCompleted=!0},handleDrop(e){this.dragActive=!1;const t=e.dataTransfer.files[0];t&&t.type.startsWith("video/")&&(this.videoFile=t)},handleFileSelect(e){const t=e.target.files[0];t&&t.type.startsWith("video/")&&(this.videoFile=t)},submitVideo(){}}},V={key:0,class:"container py-4"},C={class:"form-floating mb-2"},U={class:"form-floating mb-2"},O={class:"form-floating mb-2"},I={class:"form-floating mb-2"},G={class:"form-check mb-2"},j=["disabled"],W={key:0,class:"mt-3"},B=["disabled"];function L(e,t,i,a,s,n){return n.self?(c(),h("div",V,[t[21]||(t[21]=o("div",{class:"text-center mb-4"},[o("img",{src:"/logo.png",alt:"logo",style:{"max-width":"160px"}})],-1)),o("form",{onSubmit:t[11]||(t[11]=v((...r)=>n.submitForm&&n.submitForm(...r),["prevent"]))},[s.activeTab==="form"?(c(),h(T,{key:0},[t[17]||(t[17]=o("div",{class:"my-4 text-center"},[o("a",{href:"https://telegra.ph/Pravila-konkursa-01-27",target:"_blank",class:"btn btn-outline-primary"}," Правила участия ")],-1)),o("div",C,[p(o("input",{type:"text",class:"form-control",id:"surname",placeholder:"Фамилия","onUpdate:modelValue":t[0]||(t[0]=r=>s.form.surname=r),required:""},null,512),[[y,s.form.surname]]),t[12]||(t[12]=o("label",{for:"surname"},"Фамилия",-1))]),o("div",U,[p(o("input",{type:"text",class:"form-control",id:"name",placeholder:"Имя","onUpdate:modelValue":t[1]||(t[1]=r=>s.form.name=r),required:""},null,512),[[y,s.form.name]]),t[13]||(t[13]=o("label",{for:"name"},"Имя",-1))]),o("div",O,[p(o("input",{type:"text",class:"form-control",id:"patronymic",placeholder:"Отчество","onUpdate:modelValue":t[2]||(t[2]=r=>s.form.patronymic=r)},null,512),[[y,s.form.patronymic]]),t[14]||(t[14]=o("label",{for:"patronymic"},"Отчество",-1))]),o("div",I,[p(o("input",{type:"text",class:"form-control",id:"city",placeholder:"Город","onUpdate:modelValue":t[3]||(t[3]=r=>s.form.city=r),required:""},null,512),[[y,s.form.city]]),t[15]||(t[15]=o("label",{for:"city"},"Город",-1))]),o("div",G,[p(o("input",{class:"form-check-input",type:"checkbox",id:"agree","onUpdate:modelValue":t[4]||(t[4]=r=>s.form.agree=r),required:""},null,512),[[k,s.form.agree]]),t[16]||(t[16]=o("label",{class:"form-check-label",for:"agree"},[x(" Я ознакомлен с "),o("a",{href:"https://telegra.ph/Politika-konfidencialnosti-01-27-76",target:"_blank"},"правилами сервиса"),x(" и даю согласие на использование видео и обработку персональных данных ")],-1))]),o("button",{disabled:!s.form.agree,class:"btn btn-primary w-100 p-3",type:"submit"}," Продолжить ",8,j)],64)):b("",!0),s.activeTab==="upload"?(c(),h(T,{key:1},[o("div",{class:F(["upload-area border rounded p-4 text-center mb-2",{"upload-area--active":s.dragActive}]),onDragover:t[7]||(t[7]=v(r=>s.dragActive=!0,["prevent"])),onDragleave:t[8]||(t[8]=v(r=>s.dragActive=!1,["prevent"])),onDrop:t[9]||(t[9]=v((...r)=>n.handleDrop&&n.handleDrop(...r),["prevent"]))},[t[19]||(t[19]=o("p",{class:"mb-2 fw-bold"},"Перетащите видео сюда",-1)),t[20]||(t[20]=o("p",{class:"text-muted"},"или нажмите, чтобы выбрать файл",-1)),o("input",{type:"file",accept:"video/*",class:"d-none",ref:"fileInput",onChange:t[5]||(t[5]=(...r)=>n.handleFileSelect&&n.handleFileSelect(...r))},null,544),o("button",{type:"button",class:"btn btn-outline-secondary mt-2",onClick:t[6]||(t[6]=r=>e.$refs.fileInput.click())}," Выбрать файл "),s.videoFile?(c(),h("div",W,[t[18]||(t[18]=o("p",{class:"fw-semibold"},"Вы выбрали:",-1)),o("p",null,P(s.videoFile.name),1)])):b("",!0)],34),o("button",{onClick:t[10]||(t[10]=r=>s.activeTab="form"),class:"btn btn-outline-light w-100 p-3 mb-2",type:"button"}," Редактировать информацию "),o("button",{type:"submit",class:"btn btn-success w-100 p-3",disabled:!s.videoFile}," Отправить видео ",8,B)],64)):b("",!0)],32)])):b("",!0)}const M=_($,[["render",L],["__scopeId","data-v-23b4aff9"]]),N={data(){return{tab:"main"}},methods:{}},R=Object.assign(N,{__name:"MenuUser",setup(e){return(t,i)=>(c(),A(M))}}),q={class:"container-fluid p-3"},H={data(){return{}},computed:{tg(){return window.Telegram.WebApp}},methods:{}},J=Object.assign(H,{__name:"MenuPage",setup(e){return(t,i)=>(c(),h("div",q,[E(R)]))}});export{J as default};
